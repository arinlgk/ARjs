<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved University Campus WebAR Navigation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
        select, button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
            width: 200px;
        }
        #instructions, #error-message {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 900;
            font-size: 14px;
            max-width: 80%;
        }
        #error-message {
            background: rgba(255, 0, 0, 0.7);
            display: none;
        }
        #reset-button, #info-button {
            position: fixed;
            top: 20px;
            z-index: 900;
        }
        #reset-button {
            right: 20px;
        }
        #info-button {
            left: 20px;
        }
        #landmark-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 950;
            display: none;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <h1>University Campus Navigation</h1>
        <select id="destination-select">
            <option value="">Select Destination</option>
            <option value="library">Library</option>
            <option value="studentCenter">Student Center</option>
            <option value="scienceLab">Science Lab</option>
            <option value="sportsComplex">Sports Complex</option>
        </select>
        <button id="start-button">Start Navigation</button>
    </div>

    <div id="instructions" class="hidden">
        Follow the arrows to reach your destination. Allow camera and GPS access for accurate navigation.
    </div>

    <button id="reset-button" class="hidden">Reset Navigation</button>
    <button id="info-button" class="hidden">Show Instructions</button>
    <div id="landmark-info"></div>
    <div id="error-message"></div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="antialias: true; alpha: true"
        campus-navigation>

        <a-assets>
            <a-asset-item id="arrow-model" src="https://cdn.glitch.com/your-project-id/arrow.glb"></a-asset-item>
            <a-asset-item id="library-model" src="https://cdn.glitch.com/your-project-id/library.glb"></a-asset-item>
            <a-asset-item id="student-center-model" src="https://cdn.glitch.com/your-project-id/student-center.glb"></a-asset-item>
            <a-asset-item id="science-lab-model" src="https://cdn.glitch.com/your-project-id/science-lab.glb"></a-asset-item>
            <a-asset-item id="sports-complex-model" src="https://cdn.glitch.com/your-project-id/sports-complex.glb"></a-asset-item>
        </a-assets>

        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
    AFRAME.registerComponent('campus-navigation', {
        init: function () {
            this.destinationSelect = document.getElementById('destination-select');
            this.startButton = document.getElementById('start-button');
            this.resetButton = document.getElementById('reset-button');
            this.infoButton = document.getElementById('info-button');
            this.uiOverlay = document.getElementById('ui-overlay');
            this.instructions = document.getElementById('instructions');
            this.landmarkInfo = document.getElementById('landmark-info');
            this.errorMessage = document.getElementById('error-message');
            this.arScene = document.querySelector('a-scene');

            this.startButton.addEventListener('click', this.startNavigation.bind(this));
            this.resetButton.addEventListener('click', this.resetNavigation.bind(this));
            this.infoButton.addEventListener('click', this.toggleInstructions.bind(this));

            this.locations = {
                library: [40.7128, -74.0060],
                studentCenter: [40.7130, -74.0062],
                scienceLab: [40.7132, -74.0064],
                sportsComplex: [40.7134, -74.0066]
            };

            this.currentPath = [];
            this.arrowEntities = [];
            this.landmarkEntity = null;

            this.audio = new Howl({
                src: ['https://cdn.glitch.com/your-project-id/navigation-sound.mp3'],
                volume: 0.5
            });

            this.tick = AFRAME.utils.throttleTick(this.tick, 1000, this);

            // Check for geolocation support
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    this.userPosition = [position.coords.latitude, position.coords.longitude];
                }, () => {
                    this.showError('Unable to retrieve your location. Please enable GPS.');
                });
            } else {
                this.showError('Geolocation is not supported by your browser.');
            }
        },

        startNavigation: function () {
            const destination = this.destinationSelect.value;
            if (destination && this.locations[destination]) {
                this.uiOverlay.classList.add('hidden');
                this.arScene.style.display = 'block';
                this.instructions.classList.remove('hidden');
                this.resetButton.classList.remove('hidden');
                this.infoButton.classList.remove('hidden');
                this.generatePath(this.locations[destination]);
                this.placeLandmark(destination);
            } else {
                this.showError('Please select a valid destination.');
            }
        },

        resetNavigation: function () {
            this.uiOverlay.classList.remove('hidden');
            this.arScene.style.display = 'none';
            this.instructions.classList.add('hidden');
            this.resetButton.classList.add('hidden');
            this.infoButton.classList.add('hidden');
            this.landmarkInfo.style.display = 'none';
            this.clearNavigation();
        },

        toggleInstructions: function () {
            this.instructions.classList.toggle('hidden');
        },

        generatePath: function (destination) {
            if (!this.userPosition) {
                this.showError('User location not available. Please ensure GPS is enabled.');
                return;
            }
            const startPosition = this.userPosition;
            this.currentPath = [
                startPosition,
                [startPosition[0] + 0.0001, startPosition[1] + 0.0001],
                [startPosition[0] + 0.0002, startPosition[1] + 0.0002],
                destination
            ];
            this.createArrows();
        },

        createArrows: function () {
            this.clearNavigation();

            for (let i = 0; i < this.currentPath.length - 1; i++) {
                const start = this.currentPath[i];
                const end = this.currentPath[i + 1];
                const arrow = document.createElement('a-entity');
                arrow.setAttribute('gps-entity-place', `latitude: ${start[0]}; longitude: ${start[1]}`);
                arrow.setAttribute('gltf-model', '#arrow-model');
                arrow.setAttribute('scale', '0.5 0.5 0.5');
                arrow.setAttribute('position', '0 1.5 0');
                
                const lookAtEntity = document.createElement('a-entity');
                lookAtEntity.setAttribute('gps-entity-place', `latitude: ${end[0]}; longitude: ${end[1]}`);
                this.arScene.appendChild(lookAtEntity);
                
                arrow.setAttribute('look-at', lookAtEntity);
                
                this.arScene.appendChild(arrow);
                this.arrowEntities.push(arrow);
            }
        },

        placeLandmark: function (destination) {
            if (this.landmarkEntity) {
                this.landmarkEntity.parentNode.removeChild(this.landmarkEntity);
            }

            const landmark = document.createElement('a-entity');
            const position = this.locations[destination];
            landmark.setAttribute('gps-entity-place', `latitude: ${position[0]}; longitude: ${position[1]}`);
            landmark.setAttribute('gltf-model', `#${destination}-model`);
            landmark.setAttribute('scale', '0.1 0.1 0.1');
            landmark.setAttribute('position', '0 0 0');
            
            landmark.addEventListener('click', () => {
                this.showLandmarkInfo(destination);
            });
            
            this.arScene.appendChild(landmark);
            this.landmarkEntity = landmark;
        },

        showLandmarkInfo: function (destination) {
            const info = {
                library: "The University Library: Open 24/7 with over 1 million books.",
                studentCenter: "Student Center: Hub for student activities and dining options.",
                scienceLab: "Science Laboratory: State-of-the-art research facilities.",
                sportsComplex: "Sports Complex: Home to our championship teams."
            };
            this.landmarkInfo.textContent = info[destination];
            this.landmarkInfo.style.display = 'block';
            setTimeout(() => {
                this.landmarkInfo.style.display = 'none';
            }, 5000);
        },

        clearNavigation: function () {
            this.arrowEntities.forEach(arrow => arrow.parentNode.removeChild(arrow));
            this.arrowEntities = [];
            if (this.landmarkEntity) {
                this.landmarkEntity.parentNode.removeChild(this.landmarkEntity);
                this.landmarkEntity = null;
            }
        },

        tick: function () {
            if (this.arrowEntities.length > 0) {
                navigator.geolocation.getCurrentPosition(position => {
                    const currentPosition = [position.coords.latitude, position.coords.longitude];
                    
                    for (let i = 0; i < this.currentPath.length; i++) {
                        const waypoint = this.currentPath[i];
                        if (this.distanceBetween(currentPosition, waypoint) < 10) {
                            if (this.arrowEntities[i]) {
                                this.arrowEntities[i].parentNode.removeChild(this.arrowEntities[i]);
                                this.arrowEntities.splice(i, 1);
                                this.currentPath.splice(i, 1);
                                i--;
                                this.audio.play();
                            }
                        }
                    }

                    if (this.hasDeviatedFromPath(currentPosition)) {
                        this.recalculatePath(currentPosition);
                    }
                }, () => {
                    this.showError('Unable to update your location. Please ensure GPS is enabled.');
                });
            }
        },

        distanceBetween: function (point1, point2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = point1[0] * Math.PI / 180;
            const φ2 = point2[0] * Math.PI / 180;
            const Δφ = (point2[0] - point1[0]) * Math.PI / 180;
            const Δλ = (point2[1] - point1[1]) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        },

        hasDeviatedFromPath: function (currentPosition) {
            const threshold = 20; // meters
            for (let waypoint of this.currentPath) {
                if (this.distanceBetween(currentPosition, waypoint) < threshold) {
                    return false;
                }
            }
            return true;
        },

        recalculatePath: function (currentPosition) {
            let nearestWaypoint = this.currentPath[0];
            let minDistance = Infinity;
            for (let waypoint of this.currentPath) {
                const distance = this.distanceBetween(currentPosition, waypoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestWaypoint = waypoint;
                }
            }

            const index = this.currentPath.indexOf(nearestWaypoint);
            this.currentPath = [
                currentPosition,
                ...this.currentPath.slice(index)
            ];
            this.createArrows();
        },

        showError: function (message) {
            this.errorMessage.textContent = message;
            this.errorMessage.style.display = 'block';
            setTimeout(() => {
                this.errorMessage.style.display = 'none';
            }, 5000);
        }
    });

    window.addEventListener('error', function(event) {
        console.error("JavaScript error:", event.message, "at", event.filename, ":", event.lineno);
        const errorMessage = `Error: ${event.message} at ${event.filename}:${event.lineno}`;
        document.getElementById('error-message').textContent = errorMessage;
        document.getElementById('error-message').style.display = 'block';
        setTimeout(() => {
            document.getElementById('error-message').style.display = 'none';
        }, 5000);
    });
    </script>
</body>
</html>

